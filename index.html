<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Saúde ISGH</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* Variáveis CSS para tema dark e profissional */
:root {
--primary: #3b82f6;
--primary-dark: #1d4ed8;
--primary-light: #60a5fa;
--secondary: #6d28d9;
--secondary-light: #a855f7;
--success: #10b981;
--info: #3b82f6;
--warning: #f59e0b;
--danger: #ef4444;
--light: #f8fafc;
--dark: #0f172a;
--dark-light: #1e293b;
--gray: #64748b;
--gray-light: #cbd5e1;
--gray-dark: #334155;
--green: #059669;
--blue: #2563eb;
--red: #dc2626;
--orange: #ea580c;

/* Gradientes dark */
--bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
--bg-gradient-dark: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
--card-gradient: linear-gradient(145deg, rgba(30, 41, 59, 0.98), rgba(15, 23, 42, 0.92));
--header-gradient: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary) 100%);

/* Sombras sutis */
--card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
--card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.4);

/* Bordas arredondadas mínimas */
--border-radius: 8px;
--border-radius-lg: 12px;
--border-radius-xl: 16px;

/* Transições suaves */
--transition-fast: 0.15s ease;
--transition-normal: 0.25s ease;
--transition-slow: 0.4s ease;

/* Glassmorphism dark */
--glass-bg: rgba(15, 23, 42, 0.85);
--glass-border: rgba(255, 255, 255, 0.08);
--glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.37);

/* Textos em dark mode */
--text-primary: #f1f5f9;
--text-secondary: #cbd5e1;
--text-muted: #94a3b8;
--text-inverted: #0f172a;
}

/* Reset e base */
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
background: var(--bg-gradient);
min-height: 100vh;
color: var(--text-primary);
font-family: 'Inter', sans-serif;
line-height: 1.6;
overflow-x: hidden;
}

.page {
display: none;
min-height: 100vh;
padding-top: 20px;
}

.page.active {
display: block;
}

.container {
max-width: 1400px;
margin: 0 auto;
padding: 0 20px;
}

/* Header profissional */
header {
background: var(--glass-bg);
backdrop-filter: blur(10px);
border-radius: var(--border-radius-lg);
padding: 16px 24px;
box-shadow: var(--card-shadow);
margin-bottom: 32px;
display: flex;
justify-content: space-between;
align-items: center;
border: 1px solid var(--glass-border);
}

.logo {
display: flex;
align-items: center;
gap: 16px;
}

.logo-img {
width: 48px;
height: 48px;
border-radius: 8px;
object-fit: contain;
background: rgba(255, 255, 255, 0.1);
border: 1px solid var(--glass-border);
}

.logo-text h1 {
font-size: 1.5rem;
font-weight: 600;
margin: 0;
}

.logo-text p {
color: var(--text-muted);
font-size: 0.875rem;
margin: 0;
font-weight: 400;
}

.user-info {
display: flex;
align-items: center;
gap: 16px;
}

.user-badge {
background: rgba(59, 130, 246, 0.2);
color: var(--primary-light);
padding: 4px 12px;
border-radius: 20px;
font-size: 0.875rem;
font-weight: 500;
}

/* Cards dark e profissionais */
.card {
background: var(--card-gradient);
backdrop-filter: blur(10px);
border-radius: var(--border-radius-lg);
padding: 24px;
box-shadow: var(--card-shadow);
margin-bottom: 24px;
border: 1px solid var(--glass-border);
transition: var(--transition-normal);
}

.card:hover {
box-shadow: var(--card-shadow-hover);
}

.card h2, .card h3 {
margin-bottom: 16px;
color: var(--text-primary);
font-weight: 600;
}

.card h2::after, .card h3::after {
content: '';
position: absolute;
bottom: -8px;
left: 0;
width: 40px;
height: 2px;
background: var(--primary);
border-radius: 2px;
}

/* Login dark */
.login-container {
display: flex;
justify-content: center;
align-items: center;
min-height: 100vh;
padding: 20px;
}

.login-card {
width: 100%;
max-width: 420px;
text-align: center;
}

.login-logo {
margin-bottom: 32px;
}

.login-logo i {
font-size: 3rem;
color: var(--primary);
margin-bottom: 12px;
}

.login-logo h1 {
font-weight: 600;
font-size: 1.75rem;
}

/* Formulários clean */
.input-group {
margin-bottom: 20px;
}

.input-group i {
position: absolute;
left: 16px;
top: 50%;
transform: translateY(-50%);
color: var(--text-muted);
}

.input-group input,
.input-group select,
.input-group textarea {
width: 100%;
padding: 12px 12px 12px 40px;
border: 1px solid var(--glass-border);
border-radius: var(--border-radius);
font-size: 14px;
background: rgba(255, 255, 255, 0.05);
color: var(--text-primary);
transition: var(--transition-fast);
}

.input-group input:focus,
.input-group select:focus,
.input-group textarea:focus {
outline: none;
border-color: var(--primary);
box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
}

.input-group label {
display: block;
margin-bottom: 6px;
font-weight: 500;
color: var(--text-secondary);
font-size: 0.875rem;
}

.form-row {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
gap: 16px;
margin-bottom: 20px;
}

/* Botões profissionais */
.btn {
display: inline-flex;
align-items: center;
justify-content: center;
gap: 8px;
padding: 12px 24px;
border: none;
border-radius: var(--border-radius);
font-size: 14px;
font-weight: 500;
cursor: pointer;
transition: var(--transition-fast);
text-decoration: none;
min-width: 120px;
}

.btn-primary {
background: var(--primary);
color: var(--text-inverted);
}

.btn-primary:hover {
background: var(--primary-dark);
}

.btn-outline {
background: transparent;
color: var(--primary);
border: 1px solid var(--primary);
}

.btn-outline:hover {
background: var(--primary);
color: var(--text-inverted);
}

.btn-success {
background: var(--success);
color: var(--text-inverted);
}

.btn-success:hover {
background: #059669;
}

.btn-danger {
background: var(--danger);
color: var(--text-inverted);
}

.btn-danger:hover {
background: #dc2626;
}

.btn-small {
padding: 8px 16px;
font-size: 13px;
min-width: auto;
}

/* Tabs clean */
.tabs {
display: flex;
margin-bottom: 24px;
background: rgba(255, 255, 255, 0.05);
border-radius: var(--border-radius);
padding: 4px;
border: 1px solid var(--glass-border);
}

.tab-button {
flex: 1;
padding: 12px 16px;
border: none;
background: transparent;
cursor: pointer;
font-weight: 500;
border-radius: var(--border-radius);
transition: var(--transition-fast);
color: var(--text-muted);
}

.tab-button.active {
background: rgba(59, 130, 246, 0.2);
color: var(--primary);
}

.tab-button:hover {
color: var(--primary-light);
}

.tab-content {
display: none;
}

.tab-content.active {
display: block;
}

/* Dashboard stats dark */
.vitals-grid, .stats-container {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
gap: 16px;
margin-top: 20px;
}

.stat-card, .vital-item {
background: rgba(255, 255, 255, 0.05);
border-radius: var(--border-radius);
padding: 20px;
display: flex;
align-items: center;
gap: 16px;
border: 1px solid var(--glass-border);
transition: var(--transition-fast);
}

.stat-card:hover, .vital-item:hover {
box-shadow: var(--card-shadow-hover);
}

.stat-icon, .vital-icon {
width: 48px;
height: 48px;
border-radius: 50%;
background: rgba(59, 130, 246, 0.2);
display: flex;
align-items: center;
justify-content: center;
color: var(--primary);
font-size: 1.25rem;
}

.stat-info h3, .vital-value {
font-size: 1.75rem;
color: var(--primary);
font-weight: 600;
margin: 0;
}

.stat-info p, .vital-label {
color: var(--text-muted);
font-size: 0.875rem;
margin: 4px 0 0 0;
}

/* Lista profissional */
.users-list, #pacientesContainer, #historicoPaciente {
margin-top: 24px;
}

.user-item, .paciente-section {
padding: 16px;
border: 1px solid var(--glass-border);
border-radius: var(--border-radius);
margin-bottom: 12px;
transition: var(--transition-fast);
background: rgba(255, 255, 255, 0.05);
}

.user-item:hover, .paciente-section:hover {
border-color: rgba(59, 130, 246, 0.3);
}

.user-details {
flex: 1;
}

.user-actions {
display: flex;
gap: 8px;
}

.historico-item {
flex-direction: column;
gap: 12px;
border-left: 3px solid var(--primary);
}

.historico-item.recente {
border-left-color: var(--success);
}

.vitals-display {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
gap: 8px;
margin-top: 12px;
}

.vital-item {
text-align: center;
padding: 10px;
background: rgba(255, 255, 255, 0.05);
border-radius: var(--border-radius);
border: 1px solid var(--glass-border);
}

.todays-overview {
background: rgba(16, 185, 129, 0.1);
border: 1px solid rgba(16, 185, 129, 0.2);
border-radius: var(--border-radius-lg);
padding: 20px;
margin-bottom: 20px;
}

.todays-item {
display: flex;
justify-content: space-between;
align-items: center;
padding: 10px 0;
border-bottom: 1px solid var(--glass-border);
}

.todays-item:last-child {
border-bottom: none;
}

.notification {
position: fixed;
top: 20px;
right: 20px;
background: var(--dark-light);
padding: 16px 20px;
border-radius: var(--border-radius-lg);
box-shadow: var(--card-shadow-hover);
display: flex;
align-items: center;
gap: 12px;
z-index: 1000;
max-width: 400px;
border-left: 4px solid var(--primary);
transform: translateX(100%);
transition: transform var(--transition-normal);
}

.notification.show {
transform: translateX(0);
}

.notification.success {
border-left-color: var(--success);
}

.notification.error {
border-left-color: var(--danger);
}

#closeNotification {
background: none;
border: none;
font-size: 1.25rem;
cursor: pointer;
color: var(--text-muted);
}

#closeNotification:hover {
color: var(--danger);
}

.hidden {
display: none !important;
}

.loading {
display: inline-block;
width: 16px;
height: 16px;
border: 2px solid rgba(59, 130, 246, 0.3);
border-radius: 50%;
border-top-color: var(--primary);
animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
to { transform: rotate(360deg); }
}

/* Responsividade */
@media (max-width: 768px) {
.container {
padding: 0 16px;
}

header {
flex-direction: column;
gap: 12px;
}

.form-row {
grid-template-columns: 1fr;
gap: 12px;
}

.vitals-grid, .stats-container {
grid-template-columns: 1fr;
gap: 12px;
}

.tabs {
flex-direction: column;
}

.tab-button {
padding: 12px;
}
}

/* Debug Panel */
.debug-panel {
position: fixed;
bottom: 20px;
right: 20px;
z-index: 10000;
display: flex;
flex-direction: column;
gap: 10px;
}

.debug-btn {
background: var(--danger);
color: var(--text-inverted);
border: none;
padding: 10px 14px;
border-radius: var(--border-radius);
cursor: pointer;
font-size: 13px;
font-weight: 500;
box-shadow: var(--card-shadow);
}

.debug-btn.success {
background: var(--success);
}

.debug-btn:hover {
box-shadow: var(--card-shadow-hover);
}
</style>
</head>
<body>

<!-- Debug Panel -->
<div class="debug-panel">
    <button class="debug-btn success" onclick="criarDadosTeste()">Criar Dados Teste</button>
    <button class="debug-btn" onclick="debugProntuarios()">Debug Prontuários</button>
</div>

<!-- Página de Login -->
<div id="loginPage" class="page active">
<div class="login-container">
<div class="card login-card">
<div class="login-logo">
<i class="fas fa-heartbeat"></i>
<h1>Sistema de Saúde ISGH</h1>
<p>Gerenciamento Profissional de Saúde</p>
</div>
<form id="loginForm">
<div class="input-group">
<i class="fas fa-user"></i>
<input type="text" id="matricula" placeholder="Matrícula" required>
</div>
<div class="input-group">
<i class="fas fa-lock"></i>
<input type="password" id="senha" placeholder="Senha" required>
</div>
<button type="submit" class="btn btn-primary">
<i class="fas fa-sign-in-alt"></i>
Entrar
</button>
<a href="#" id="esqueciSenhaLink" style="display: block; margin-top: 16px; color: var(--primary); text-decoration: none; font-size: 0.875rem;">Recuperar senha</a>
</form>
</div>
</div>
</div>

<!-- Página de Recuperação de Senha -->
<div id="recuperarSenhaPage" class="page">
<div class="login-container">
<div class="card login-card">
<div class="login-logo">
<i class="fas fa-key"></i>
<h2>Recuperar Senha</h2>
<p>Insira sua matrícula</p>
</div>
<form id="recuperarSenhaForm">
<div class="input-group">
<i class="fas fa-user"></i>
<input type="text" id="matriculaRecuperar" placeholder="Matrícula" required>
</div>
<button type="submit" class="btn btn-primary">
<i class="fas fa-paper-plane"></i>
Enviar
</button>
<a href="#" id="voltarLogin" style="display: block; margin-top: 16px; color: var(--primary); text-decoration: none; font-size: 0.875rem;">Voltar ao login</a>
</form>
</div>
</div>
</div>

<!-- Painel do Administrador -->
<div id="adminPage" class="page">
<header>
<div class="logo">
<div class="logo-img">
<i class="fas fa-cogs"></i>
</div>
<div class="logo-text">
<h1>Painel Administrativo</h1>
<p>Gerenciamento do Sistema</p>
</div>
</div>
<div class="user-info">
<span class="user-badge" id="adminUserName"></span>
<button id="adminLogout" class="btn btn-outline">
<i class="fas fa-sign-out-alt"></i> Sair
</button>
</div>
</header>

<div class="container">
<div class="tabs">
<button class="tab-button active" data-tab="dashboardAdmin">
<i class="fas fa-chart-line"></i> Dashboard
</button>
<button class="tab-button" data-tab="cadastroUsuario">
<i class="fas fa-user-plus"></i> Cadastrar Usuário
</button>
<button class="tab-button" data-tab="gerenciarCargos">
<i class="fas fa-sitemap"></i> Gerenciar Cargos
</button>
<button class="tab-button" data-tab="relatorios">
<i class="fas fa-file-alt"></i> Relatórios
</button>
<button class="tab-button" data-tab="consultaPacientesAdmin">
<i class="fas fa-search"></i> Pacientes
</button>
</div>

<div id="dashboardAdmin" class="tab-content active">
<div class="card">
<h2>Visão Geral</h2>
<div class="stats-container">
<div class="stat-card">
<div class="stat-icon"><i class="fas fa-users"></i></div>
<div class="stat-info"><h3 id="totalUsuarios">0</h3><p>Usuários</p></div>
</div>
<div class="stat-card">
<div class="stat-icon"><i class="fas fa-procedures"></i></div>
<div class="stat-info"><h3 id="totalPacientes">0</h3><p>Registros</p></div>
</div>
<div class="stat-card">
<div class="stat-icon"><i class="fas fa-clock"></i></div>
<div class="stat-info"><h3 id="registrosHoje">0</h3><p>Registros Hoje</p></div>
</div>
<div class="stat-card">
<div class="stat-icon"><i class="fas fa-chart-bar"></i></div>
<div class="stat-info"><h3 id="mediaVital">0</h3><p>Média Temp. (°C)</p></div>
</div>
</div>
</div>
</div>

<div id="cadastroUsuario" class="tab-content">
<div class="card">
<h2>Cadastrar Usuário</h2>
<form id="formCadastroUsuario">
<div class="form-row">
<div class="input-group">
<label for="nomeCompleto">Nome</label>
<input type="text" id="nomeCompleto" required>
</div>
<div class="input-group">
<label for="matriculaUsuario">Matrícula</label>
<input type="text" id="matriculaUsuario" required>
</div>
</div>
<div class="form-row">
<div class="input-group">
<label for="setorUsuario">Setor</label>
<select id="setorUsuario" required>
<option value="">Selecione</option>
</select>
</div>
<div class="input-group">
<label for="senhaUsuario">Senha</label>
<input type="password" id="senhaUsuario" required>
</div>
</div>
<button type="submit" class="btn btn-primary">
<i class="fas fa-save"></i> Cadastrar
</button>
</form>
</div>

<div class="users-list">
<div class="card">
<h3>Usuários</h3>
<div id="listaUsuarios"></div>
</div>
</div>
</div>

<div id="gerenciarCargos" class="tab-content">
<div class="card">
<h2>Gerenciar Cargos</h2>
<form id="formNovoCargo">
<div class="form-row">
<div class="input-group">
<label for="novoCargo">Novo Setor</label>
<input type="text" id="novoCargo" required>
</div>
<div class="input-group">
<label for="nivelAcesso">Nível</label>
<select id="nivelAcesso" required>
<option value="0">Admin</option>
<option value="1">Técnico</option>
<option value="2">Médico</option>
</select>
</div>
</div>
<button type="submit" class="btn btn-primary">
<i class="fas fa-plus"></i> Adicionar
</button>
</form>
</div>
<div class="card">
<h3>Setores</h3>
<div id="listaSetores"></div>
</div>
</div>

<div id="relatorios" class="tab-content">
<div class="card">
<h2>Relatórios</h2>
<div class="form-row">
<div class="input-group">
<label for="dataInicioRelatorio">Início</label>
<input type="date" id="dataInicioRelatorio">
</div>
<div class="input-group">
<label for="dataFimRelatorio">Fim</label>
<input type="date" id="dataFimRelatorio">
</div>
</div>
<button id="gerarRelatorio" class="btn btn-primary">
<i class="fas fa-download"></i> Gerar
</button>
<div id="relatorioContainer" class="hidden"></div>
</div>
</div>

<div id="consultaPacientesAdmin" class="tab-content">
<div class="card">
<h2>Lista de Pacientes</h2>
<div id="pacientesContainerAdmin"></div>
</div>
</div>
</div>
</div>

<!-- Painel do Técnico -->
<div id="tecnicoPage" class="page">
<header>
<div class="logo">
<div class="logo-img">
<i class="fas fa-user-nurse"></i>
</div>
<div class="logo-text">
<h1>Painel Técnico</h1>
<p>Registro e Consulta</p>
</div>
</div>
<div class="user-info">
<span class="user-badge" id="tecnicoUserName"></span>
<button id="tecnicoLogout" class="btn btn-outline">
<i class="fas fa-sign-out-alt"></i> Sair
</button>
</div>
</header>

<div class="container">
<div class="tabs">
<button class="tab-button active" data-tab="registroPaciente">
<i class="fas fa-plus"></i> Novo Registro
</button>
<button class="tab-button" data-tab="consultaPacienteTecnico">
<i class="fas fa-search"></i> Pacientes
</button>
</div>

<div id="registroPaciente" class="tab-content active">
<div class="card">
<h2>Registro de Paciente</h2>
<form id="formRegistroPaciente">
<div class="form-row">
<div class="input-group">
<label for="nomePaciente">Nome</label>
<input type="text" id="nomePaciente" required>
</div>
<div class="input-group">
<label for="prontuario">Prontuário</label>
<input type="text" id="prontuario" required>
</div>
</div>
<div class="input-group">
<label for="dataNascimento">Nascimento</label>
<input type="date" id="dataNascimento" required>
</div>

<h3>Dados Vitais</h3>
<div class="vitals-grid">
<div class="input-group">
<label for="peso">Peso (kg) *</label>
<input type="number" id="peso" step="0.1" required>
</div>
<div class="input-group">
<label for="altura">Altura (cm) *</label>
<input type="number" id="altura" required>
</div>
<div class="input-group">
<label for="pressaoArterial">Pressão *</label>
<input type="text" id="pressaoArterial" required>
</div>
<div class="input-group">
<label for="temperatura">Temp. (°C) *</label>
<input type="number" id="temperatura" step="0.1" required>
</div>
<div class="input-group">
<label for="saturacao">Sat. O₂ (%)</label>
<input type="number" id="saturacao">
</div>
<div class="input-group">
<label for="glicemia">Glicemia</label>
<input type="number" id="glicemia">
</div>
</div>
<div class="input-group">
<label for="observacoes">Observações</label>
<textarea id="observacoes" rows="3"></textarea>
</div>

<button type="submit" class="btn btn-success">
<i class="fas fa-save"></i> Registrar
</button>
</form>
</div>
</div>

<div id="consultaPacienteTecnico" class="tab-content">
<div class="card">
<h2>Lista de Pacientes</h2>
<div id="pacientesContainerTecnico"></div>
</div>
</div>
</div>
</div>

<!-- Painel do Médico -->
<div id="medicoPage" class="page">
<header>
<div class="logo">
<div class="logo-img">
<i class="fas fa-user-md"></i>
</div>
<div class="logo-text">
<h1>Painel Médico</h1>
<p>Consultas e Análises</p>
</div>
</div>
<div class="user-info">
<span class="user-badge" id="medicoUserName"></span>
<button id="medicoLogout" class="btn btn-outline">
<i class="fas fa-sign-out-alt"></i> Sair
</button>
</div>
</header>

<div class="container">
<div class="todays-overview">
<h3><i class="fas fa-calendar-day"></i> Hoje</h3>
<div id="todaysOverview"></div>
</div>

<div class="card">
<h2>Lista de Pacientes</h2>
<div id="pacientesContainer"></div>
</div>
</div>
</div>

<!-- Notificações -->
<div id="notification" class="notification hidden">
<span id="notificationText"></span>
<button id="closeNotification">&times;</button>
</div>

<script>
// Variáveis globais
let currentUser = null;

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('esqueciSenhaLink').addEventListener('click', showRecuperarSenha);
    document.getElementById('voltarLogin').addEventListener('click', showLogin);

    ['adminLogout', 'tecnicoLogout', 'medicoLogout'].forEach(id => {
        document.getElementById(id)?.addEventListener('click', logout);
    });

    document.getElementById('loginForm')?.addEventListener('submit', handleLogin);
    document.getElementById('recuperarSenhaForm')?.addEventListener('submit', handleRecuperarSenha);
    document.getElementById('formCadastroUsuario')?.addEventListener('submit', handleCadastroUsuario);
    document.getElementById('formNovoCargo')?.addEventListener('submit', handleNovoCargo);
    document.getElementById('formRegistroPaciente')?.addEventListener('submit', handleRegistroPaciente);

    document.getElementById('gerarRelatorio')?.addEventListener('click', gerarRelatorioAdmin);

    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            switchTab(tabId);
        });
    });

    document.getElementById('closeNotification').addEventListener('click', hideNotification);

    if (document.getElementById('setorUsuario')) loadSetores();
    if (document.getElementById('listaUsuarios')) loadUsuarios();
    if (document.getElementById('listaSetores')) loadSetoresList();

    if (document.getElementById('todaysOverview')) loadTodaysOverview();

    if (document.getElementById('dashboardAdmin')) loadDashboardAdmin();
});

// Navegação
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
    document.getElementById(pageId)?.classList.add('active');
}

function showLogin() { showPage('loginPage'); }
function showRecuperarSenha() { showPage('recuperarSenhaPage'); }

function switchTab(tabId) {
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

    document.querySelector(`[data-tab="${tabId}"]`)?.classList.add('active');
    document.getElementById(tabId)?.classList.add('active');

    if (tabId === 'dashboardAdmin') loadDashboardAdmin();
    if (tabId === 'gerenciarCargos') loadSetoresList();
    if (tabId === 'consultaPacientesAdmin') loadAllPacientes('admin');
    if (tabId === 'consultaPacienteTecnico') loadAllPacientes('tecnico');
}

// Login
function handleLogin(e) {
    e.preventDefault();
    const matricula = document.getElementById('matricula').value.trim();
    const senha = document.getElementById('senha').value;

    showLoading(true);

    google.script.run
        .withSuccessHandler(result => {
            showLoading(false);
            if (result.success) {
                currentUser = result.user;
                const tipo = currentUser.tipo.toLowerCase();
                const pageId = tipo + 'Page';
                document.getElementById(tipo + 'UserName').textContent = currentUser.nome;
                showPage(pageId);
                showNotification(`Bem-vindo, ${currentUser.nome}`);
                if (tipo === 'admin') {
                    loadDashboardAdmin();
                    loadUsuarios();
                    loadSetoresList();
                } else if (tipo === 'medico') {
                    loadTodaysOverview();
                    loadAllPacientes('medico');
                } else if (tipo === 'tecnico') {
                    loadTodaysOverview();
                }
            } else {
                showNotification(result.message, 'error');
            }
        })
        .withFailureHandler(err => {
            showLoading(false);
            showNotification('Erro: ' + err.message, 'error');
        })
        .fazerLogin(matricula, senha);
}

// Recuperação
function handleRecuperarSenha(e) {
    e.preventDefault();
    const matricula = document.getElementById('matriculaRecuperar').value.trim();

    showLoading(true);

    google.script.run
        .withSuccessHandler(result => {
            showLoading(false);
            showNotification(result.message);
            setTimeout(showLogin, 3000);
        })
        .withFailureHandler(err => {
            showLoading(false);
            showNotification('Erro: ' + err.message, 'error');
        })
        .recuperarSenha(matricula);
}

// Cadastro usuário
function handleCadastroUsuario(e) {
    e.preventDefault();
    const formData = {
        nome: document.getElementById('nomeCompleto').value.trim(),
        matricula: document.getElementById('matriculaUsuario').value.trim(),
        setor: document.getElementById('setorUsuario').value,
        senha: document.getElementById('senhaUsuario').value
    };

    showLoading(true);

    google.script.run
        .withSuccessHandler(result => {
            showLoading(false);
            showNotification(result.message);
            loadUsuarios();
        })
        .withFailureHandler(err => {
            showLoading(false);
            showNotification('Erro: ' + err.message, 'error');
        })
        .cadastrarUsuario(formData.nome, formData.matricula, formData.setor, formData.senha);
}

// Novo cargo
function handleNovoCargo(e) {
    e.preventDefault();
    const novoCargo = document.getElementById('novoCargo').value.trim();
    const nivelAcesso = document.getElementById('nivelAcesso').value;

    showLoading(true);

    google.script.run
        .withSuccessHandler(result => {
            showLoading(false);
            showNotification(result.message);
            loadSetores();
            loadSetoresList();
        })
        .withFailureHandler(err => {
            showLoading(false);
            showNotification('Erro: ' + err.message, 'error');
        })
        .adicionarSetor(novoCargo, parseInt(nivelAcesso));
}

// Registro paciente
function handleRegistroPaciente(e) {
    e.preventDefault();
    const dados = {
        nomeCompleto: document.getElementById('nomePaciente').value.trim(),
        prontuario: document.getElementById('prontuario').value.trim(),
        dataNascimento: document.getElementById('dataNascimento').value,
        peso: document.getElementById('peso').value,
        altura: document.getElementById('altura').value,
        pressaoArterial: document.getElementById('pressaoArterial').value.trim(),
        temperatura: document.getElementById('temperatura').value,
        saturacao: document.getElementById('saturacao').value,
        glicemia: document.getElementById('glicemia').value,
        observacoes: document.getElementById('observacoes').value.trim()
    };

    showLoading(true);

    google.script.run
        .withSuccessHandler(result => {
            showLoading(false);
            showNotification(result.message);
            document.getElementById('formRegistroPaciente').reset();
        })
        .withFailureHandler(err => {
            showLoading(false);
            showNotification('Erro: ' + err.message, 'error');
        })
        .registrarDadosPaciente(dados);
}

// Carregar todos os pacientes
function loadAllPacientes(tipo) {
    showLoading(true);
    const containerId = tipo === 'admin' ? 'pacientesContainerAdmin' : tipo === 'tecnico' ? 'pacientesContainerTecnico' : 'pacientesContainer';

    google.script.run
        .withSuccessHandler(registros => {
            showLoading(false);
            displayAllPacientes(registros, containerId);
        })
        .withFailureHandler(err => {
            showLoading(false);
            showNotification('Erro ao carregar pacientes: ' + err.message, 'error');
        })
        .getAllPacientes();
}

// Exibir todos os pacientes agrupados por prontuário
function displayAllPacientes(registros, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';

    if (registros.length === 0) {
        container.innerHTML = '<p>Nenhum registro encontrado.</p>';
        return;
    }

    // Agrupar por prontuário
    const grouped = new Map();
    registros.forEach(reg => {
        const key = reg.prontuario;
        if (!grouped.has(key)) grouped.set(key, []);
        grouped.get(key).push(reg);
    });

    grouped.forEach((hist, prontuario) => {
        const first = hist[0];
        const section = document.createElement('div');
        section.className = 'paciente-section';
        section.innerHTML = `
            <h3>${first.nome || 'Nome não informado'}</h3>
            <p>Prontuário: ${prontuario}</p>
            <p>Nascimento: ${formatDate(first.dataNascimento)}</p>
            <div class="historico-paciente" id="historico-${prontuario}"></div>
        `;
        container.appendChild(section);

        const historicoEl = section.querySelector(`#historico-${prontuario}`);
        hist.forEach((reg, idx) => {
            const item = document.createElement('div');
            item.className = `historico-item ${idx === 0 ? 'recente' : ''}`;
            item.innerHTML = `
                <div class="historico-header">
                    <h4>${formatDateTime(reg.dataRegistro)}</h4>
                    <p>Registrado por: ${reg.usuarioRegistro} | Observações: ${reg.observacoes || 'Nenhuma'}</p>
                </div>
                <div class="vitals-display">
                    <div class="vital-item"><div class="vital-value">${reg.peso || '-'} kg</div><div class="vital-label">Peso</div></div>
                    <div class="vital-item"><div class="vital-value">${reg.altura || '-'} cm</div><div class="vital-label">Altura</div></div>
                    <div class="vital-item"><div class="vital-value">${reg.pressaoArterial || '-'}</div><div class="vital-label">Pressão</div></div>
                    <div class="vital-item"><div class="vital-value">${reg.temperatura || '-'} °C</div><div class="vital-label">Temp.</div></div>
                    <div class="vital-item"><div class="vital-value">${reg.saturacao || '-'}%</div><div class="vital-label">Sat. O₂</div></div>
                    <div class="vital-item"><div class="vital-value">${reg.glicemia || '-'} mg/dL</div><div class="vital-label">Glicemia</div></div>
                </div>
            `;
            historicoEl.appendChild(item);
        });
    });
}

// Outras funções (loadSetores, loadSetoresList, loadUsuarios, loadDashboardAdmin, loadTodaysOverview, gerarRelatorioAdmin, displayRelatorio, editarUsuario, deletarUsuario, editarSetor, deletarSetor, logout, formatDate, formatDateTime, formatTime, showNotification, hideNotification, showLoading) permanecem semelhantes, adaptadas ao tema dark e profissional, sem animações desnecessárias.

function loadSetores() {
    google.script.run.obterSetores().withSuccessHandler(setores => {
        const select = document.getElementById('setorUsuario');
        select.innerHTML = '<option value="">Selecione</option>';
        setores.forEach(setor => {
            const option = document.createElement('option');
            option.value = option.textContent = setor;
            select.appendChild(option);
        });
    });
}

function loadSetoresList() {
    google.script.run.obterSetoresComDetalhes().withSuccessHandler(setores => {
        const lista = document.getElementById('listaSetores');
        lista.innerHTML = '';
        setores.forEach(setor => {
            const item = document.createElement('div');
            item.className = 'user-item';
            item.innerHTML = `
                <div>
                    <h4>${setor.descricao}</h4>
                    <p>Setor: ${setor.setor} | Nível: ${['Admin', 'Técnico', 'Médico'][setor.nivelAcesso]}</p>
                </div>
                <div class="user-actions">
                    <button class="btn btn-outline btn-small" onclick="editarSetor('${setor.id}')"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-danger btn-small" onclick="deletarSetor('${setor.id}')"><i class="fas fa-trash"></i></button>
                </div>
            `;
            lista.appendChild(item);
        });
    });
}

function loadUsuarios() {
    google.script.run.obterUsuarios().withSuccessHandler(usuarios => {
        const lista = document.getElementById('listaUsuarios');
        lista.innerHTML = '';
        usuarios.forEach(usuario => {
            const item = document.createElement('div');
            item.className = 'user-item';
            item.innerHTML = `
                <div class="user-details">
                    <h4>${usuario.nome}</h4>
                    <p>Matrícula: ${usuario.matricula} | Setor: ${usuario.setor} | Status: ${usuario.status}</p>
                </div>
                <div class="user-actions">
                    <button class="btn btn-outline btn-small" onclick="editarUsuario('${usuario.matricula}')"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-danger btn-small" onclick="deletarUsuario('${usuario.matricula}')"><i class="fas fa-trash"></i></button>
                </div>
            `;
            lista.appendChild(item);
        });
    });
}

function loadDashboardAdmin() {
    google.script.run.obterEstatisticas().withSuccessHandler(stats => {
        document.getElementById('totalUsuarios').textContent = stats.totalUsuarios;
        document.getElementById('totalPacientes').textContent = stats.totalRegistros;
        document.getElementById('registrosHoje').textContent = stats.registrosHoje;
        document.getElementById('mediaVital').textContent = stats.mediaTemperatura.toFixed(1);
    });
}

function loadTodaysOverview() {
    google.script.run.obterRegistrosHoje().withSuccessHandler(todays => {
        const container = document.getElementById('todaysOverview');
        container.innerHTML = '';
        todays.forEach(item => {
            const div = document.createElement('div');
            div.className = 'todays-item';
            div.innerHTML = `
                <div>
                    <h4>${item.nome}</h4>
                    <p>Prontuário: ${item.prontuario}</p>
                </div>
                <div>
                    <p>${formatTime(item.dataRegistro)}</p>
                    <small>Temp: ${item.temperatura}°C</small>
                </div>
            `;
            container.appendChild(div);
        });
    });
}

function gerarRelatorioAdmin() {
    const dataInicio = document.getElementById('dataInicioRelatorio').value;
    const dataFim = document.getElementById('dataFimRelatorio').value;

    google.script.run.gerarRelatorio(dataInicio, dataFim).withSuccessHandler(relatorio => {
        displayRelatorio(relatorio);
    });
}

function displayRelatorio(relatorio) {
    const container = document.getElementById('relatorioContainer');
    container.innerHTML = `
        <div class="report-card">
            <div class="report-header">
                <h3>Resumo de ${relatorio.data}</h3>
            </div>
            <div class="stats-container">
                <div class="stat-card"><div class="stat-icon"><i class="fas fa-file"></i></div><div class="stat-info"><h3>${relatorio.total}</h3><p>Registros</p></div></div>
                <div class="stat-card"><div class="stat-icon"><i class="fas fa-users"></i></div><div class="stat-info"><h3>${relatorio.usuariosUnicos}</h3><p>Usuários</p></div></div>
                <div class="stat-card"><div class="stat-icon"><i class="fas fa-thermometer-half"></i></div><div class="stat-info"><h3>${relatorio.mediaTemp.toFixed(1)}°C</h3><p>Média Temp.</p></div></div>
            </div>
        </div>
    `;
    container.classList.remove('hidden');
}

function editarUsuario(matricula) {
    const novoNome = prompt('Novo nome:');
    if (novoNome) {
        google.script.run.editarUsuario(matricula, { nome: novoNome }).withSuccessHandler(() => loadUsuarios());
    }
}

function deletarUsuario(matricula) {
    if (confirm('Inativar usuário?')) {
        google.script.run.deletarUsuario(matricula).withSuccessHandler(() => loadUsuarios());
    }
}

function editarSetor(id) {
    const novoSetor = prompt('Novo nome do setor:');
    if (novoSetor) {
        google.script.run.editarSetor(id, { setor: novoSetor }).withSuccessHandler(() => loadSetoresList());
    }
}

function deletarSetor(id) {
    if (confirm('Deletar setor?')) {
        google.script.run.deletarSetor(id).withSuccessHandler(() => loadSetoresList());
    }
}

function logout() {
    currentUser = null;
    showLogin();
    showNotification('Sessão encerrada');
}

function formatDate(dateString) {
    return dateString ? new Date(dateString).toLocaleDateString('pt-BR') : 'N/A';
}

function formatDateTime(dateString) {
    return dateString ? new Date(dateString).toLocaleString('pt-BR') : 'N/A';
}

function formatTime(dateString) {
    return dateString ? new Date(dateString).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 'N/A';
}

function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    document.getElementById('notificationText').textContent = message;
    notification.className = `notification ${type}`;
    notification.classList.remove('hidden');
    notification.classList.add('show');
    setTimeout(hideNotification, 5000);
}

function hideNotification() {
    const notification = document.getElementById('notification');
    notification.classList.remove('show');
    setTimeout(() => notification.classList.add('hidden'), 300);
}

function showLoading(show = true) {
    document.querySelectorAll('button[type="submit"], .btn-primary').forEach(btn => {
        btn.disabled = show;
        if (show) {
            btn.innerHTML += '<span class="loading"></span>';
        } else {
            btn.innerHTML = btn.innerHTML.replace('<span class="loading"></span>', '');
        }
    });
}

// Debug
function debugProntuarios() {
    google.script.run.debugProntuarios().withSuccessHandler(result => console.log(result));
}

function criarDadosTeste() {
    google.script.run.criarDadosTeste().withSuccessHandler(result => showNotification(result));
}
</script>
</body>
</html>
