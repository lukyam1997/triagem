<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Central de Triagem ISGH</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: dark;
      --background: #0f172a;
      --surface: #111b33;
      --surface-alt: #152041;
      --border: rgba(148, 163, 184, 0.12);
      --primary: #3b82f6;
      --primary-dark: #1d4ed8;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --radius: 14px;
      --shadow: 0 16px 40px rgba(15, 23, 42, 0.45);
      --transition: 0.25s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, rgba(59, 130, 246, 0.28) 0%, rgba(15, 23, 42, 0.92) 55%, #0b1325 100%);
      font-family: 'Inter', sans-serif;
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    .app-container {
      width: min(1180px, 95vw);
      margin: 40px auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(17, 27, 51, 0.9);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px 28px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      margin-bottom: 28px;
    }

    .brand {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .brand-logo {
      width: 54px;
      height: 54px;
      display: grid;
      place-items: center;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(59, 130, 246, 0));
      border: 1px solid rgba(59, 130, 246, 0.3);
      font-weight: 700;
      color: var(--primary);
    }

    .brand h1 {
      font-size: 1.35rem;
      font-weight: 600;
    }

    .brand span {
      display: block;
      color: var(--text-muted);
      font-size: 0.85rem;
      font-weight: 400;
    }

    .user-chip {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.12);
      border: 1px solid rgba(59, 130, 246, 0.25);
      color: var(--primary);
      font-weight: 500;
    }

    nav {
      display: grid;
      grid-auto-flow: column;
      gap: 12px;
      margin-bottom: 24px;
    }

    .nav-button {
      border: 1px solid transparent;
      border-radius: 12px;
      padding: 14px 20px;
      background: rgba(17, 27, 51, 0.7);
      color: var(--text);
      font-weight: 500;
      text-align: left;
      cursor: pointer;
      transition: transform var(--transition), background var(--transition), border var(--transition);
    }

    .nav-button:hover {
      transform: translateY(-2px);
      border-color: rgba(59, 130, 246, 0.35);
    }

    .nav-button.active {
      background: rgba(59, 130, 246, 0.16);
      border-color: rgba(59, 130, 246, 0.4);
      color: var(--primary);
    }

    main {
      display: grid;
      gap: 24px;
    }

    section {
      display: none;
      background: rgba(17, 27, 51, 0.75);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 24px;
    }

    section.active {
      display: block;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
    }

    h2 {
      font-size: 1.15rem;
      font-weight: 600;
    }

    p.muted {
      color: var(--text-muted);
      font-size: 0.95rem;
      margin-top: 6px;
    }

    form {
      display: grid;
      gap: 18px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
    }

    label {
      display: grid;
      gap: 8px;
      font-size: 0.95rem;
      color: var(--text-muted);
    }

    input, select, textarea {
      width: 100%;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.18);
      border-radius: 10px;
      padding: 12px 14px;
      color: var(--text);
      font-size: 0.95rem;
      transition: border var(--transition), box-shadow var(--transition);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: rgba(59, 130, 246, 0.55);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }

    .actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    button.primary {
      padding: 12px 24px;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      cursor: pointer;
      transition: transform var(--transition), box-shadow var(--transition);
      box-shadow: 0 10px 24px rgba(59, 130, 246, 0.25);
    }

    button.primary:disabled {
      opacity: 0.6;
      cursor: progress;
      box-shadow: none;
    }

    button.secondary {
      padding: 12px 20px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.28);
      background: transparent;
      color: var(--text);
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 0.93rem;
    }

    thead {
      background: rgba(59, 130, 246, 0.12);
    }

    th, td {
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }

    th {
      font-weight: 600;
      color: var(--primary);
    }

    tr:hover td {
      background: rgba(59, 130, 246, 0.08);
    }

    .badge {
      display: inline-flex;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(59, 130, 246, 0.16);
      color: var(--primary);
      border: 1px solid rgba(59, 130, 246, 0.25);
    }

    .status-inativo {
      background: rgba(239, 68, 68, 0.18);
      color: var(--danger);
      border-color: rgba(239, 68, 68, 0.28);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
      margin-top: 12px;
    }

    .stat-card {
      background: rgba(15, 23, 42, 0.75);
      border: 1px solid rgba(148, 163, 184, 0.16);
      border-radius: 12px;
      padding: 18px;
      display: grid;
      gap: 6px;
    }

    .stat-card span {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .stat-card strong {
      font-size: 1.6rem;
      font-weight: 600;
    }

    .empty-state {
      padding: 24px;
      text-align: center;
      color: var(--text-muted);
      background: rgba(15, 23, 42, 0.65);
      border: 1px dashed rgba(148, 163, 184, 0.2);
      border-radius: 12px;
    }

    .login-card {
      width: min(420px, 92vw);
      margin: 80px auto;
      padding: 32px;
      background: rgba(17, 27, 51, 0.85);
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: var(--shadow);
      display: grid;
      gap: 22px;
    }

    .login-card h1 {
      font-size: 1.55rem;
      text-align: center;
    }

    .login-card p {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .toast {
      position: fixed;
      right: 24px;
      bottom: 24px;
      min-width: 260px;
      padding: 16px 20px;
      border-radius: 14px;
      border: 1px solid transparent;
      background: rgba(17, 27, 51, 0.9);
      color: var(--text);
      box-shadow: var(--shadow);
      opacity: 0;
      transform: translateY(20px);
      pointer-events: none;
      transition: opacity var(--transition), transform var(--transition);
      z-index: 2000;
    }

    .toast.visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .toast.success { border-color: rgba(16, 185, 129, 0.4); }
    .toast.error { border-color: rgba(239, 68, 68, 0.45); }
    .toast.info { border-color: rgba(59, 130, 246, 0.4); }

    @media (max-width: 768px) {
      header {
        flex-direction: column;
        gap: 20px;
        align-items: flex-start;
      }

      nav {
        grid-auto-flow: row;
      }

      .actions {
        flex-direction: column-reverse;
        align-items: stretch;
      }

      .actions button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="toast" class="toast"></div>

  <div id="loginView" class="login-card">
    <div>
      <h1>Central de Triagem ISGH</h1>
      <p>Acesse o sistema utilizando sua matrícula e senha institucional.</p>
    </div>
    <form id="loginForm">
      <label>
        Matrícula
        <input type="text" id="loginMatricula" autocomplete="username" required />
      </label>
      <label>
        Senha
        <input type="password" id="loginSenha" autocomplete="current-password" required />
      </label>
      <button class="primary" type="submit">Entrar</button>
    </form>
  </div>

  <div id="app" class="app-container" hidden>
    <header>
      <div class="brand">
        <div class="brand-logo">IS</div>
        <div>
          <h1>Central de Triagem</h1>
          <span>Monitoramento clínico em tempo real</span>
        </div>
      </div>
      <div class="user-chip" id="userChip"></div>
    </header>

    <nav id="navigation"></nav>

    <main>
      <section id="section-dashboard" class="active">
        <div class="section-header">
          <div>
            <h2>Visão Geral</h2>
            <p class="muted">Resumo das últimas movimentações e estatísticas principais.</p>
          </div>
        </div>
        <div class="stats-grid" id="statsGrid"></div>
      </section>

      <section id="section-paciente">
        <div class="section-header">
          <div>
            <h2>Novo Atendimento</h2>
            <p class="muted">Preencha as informações clínicas iniciais do paciente.</p>
          </div>
        </div>
        <form id="pacienteForm">
          <div class="grid-2">
            <label>Nome do paciente<input type="text" name="nomePaciente" required /></label>
            <label>Nº do prontuário<input type="text" name="prontuario" /></label>
            <label>Data de nascimento<input type="date" name="dataNascimento" /></label>
            <label>Pressão arterial<input type="text" name="pressaoArterial" placeholder="120/80" /></label>
            <label>Frequência cardíaca<input type="number" name="frequenciaCardiaca" min="0" /></label>
            <label>Temperatura (°C)<input type="number" step="0.1" name="temperatura" min="30" max="45" /></label>
            <label>Saturação (%)<input type="number" name="saturacao" min="0" max="100" /></label>
            <label>Glicemia (mg/dL)<input type="number" name="glicemia" min="0" /></label>
          </div>
          <label>Queixa principal<textarea name="queixaPrincipal" required></textarea></label>
          <label>Observações adicionais<textarea name="observacoes"></textarea></label>
          <div class="actions">
            <button type="reset" class="secondary">Limpar</button>
            <button type="submit" class="primary">Registrar atendimento</button>
          </div>
        </form>
      </section>

      <section id="section-registros">
        <div class="section-header">
          <div>
            <h2>Registros de atendimento</h2>
            <p class="muted">Pesquise por pacientes, prontuários ou queixas.</p>
          </div>
          <input type="search" id="buscaPacientes" placeholder="Buscar paciente" />
        </div>
        <div id="pacientesLista"></div>
      </section>

      <section id="section-admin">
        <div class="section-header">
          <div>
            <h2>Administração</h2>
            <p class="muted">Gerencie equipes, acessos e cadastros do sistema.</p>
          </div>
        </div>
        <div class="grid-2">
          <div>
            <h3>Setores</h3>
            <form id="setorForm">
              <input type="hidden" name="id" />
              <label>Descrição<input type="text" name="descricao" required /></label>
              <label>Nível de acesso
                <select name="nivelAcesso" required>
                  <option value="0">Administrador</option>
                  <option value="1">Profissional de saúde</option>
                  <option value="2">Consulta/Visualização</option>
                </select>
              </label>
              <label>Status
                <select name="ativo" required>
                  <option value="true">Ativo</option>
                  <option value="false">Inativo</option>
                </select>
              </label>
              <div class="actions">
                <button type="reset" class="secondary">Cancelar</button>
                <button type="submit" class="primary">Salvar setor</button>
              </div>
            </form>
            <div id="setoresLista" class="empty-state">Nenhum setor cadastrado.</div>
          </div>
          <div>
            <h3>Usuários</h3>
            <form id="usuarioForm">
              <label>Nome completo<input type="text" name="nome" required /></label>
              <label>Matrícula<input type="text" name="matricula" required /></label>
              <label>Setor<select name="setor" required></select></label>
              <label>Nível de acesso
                <select name="nivelAcesso" required>
                  <option value="0">Administrador</option>
                  <option value="1">Profissional de saúde</option>
                  <option value="2">Consulta/Visualização</option>
                </select>
              </label>
              <label>Senha provisória<input type="password" name="senha" required /></label>
              <label>Status
                <select name="status" required>
                  <option value="ATIVO">Ativo</option>
                  <option value="INATIVO">Inativo</option>
                </select>
              </label>
              <div class="actions">
                <button type="reset" class="secondary">Limpar</button>
                <button type="submit" class="primary">Salvar usuário</button>
              </div>
            </form>
            <div id="usuariosLista" class="empty-state">Nenhum usuário cadastrado.</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    (function () {
      const state = {
        user: null,
        pacientes: [],
        setores: [],
        usuarios: [],
        estatisticas: null
      };

      const sections = ['dashboard', 'paciente', 'registros', 'admin'];

      const toast = document.getElementById('toast');
      const app = document.getElementById('app');
      const loginView = document.getElementById('loginView');
      const loginForm = document.getElementById('loginForm');
      const loginButton = loginForm.querySelector('button');
      const nav = document.getElementById('navigation');
      const userChip = document.getElementById('userChip');
      const pacienteForm = document.getElementById('pacienteForm');
      const pacientesLista = document.getElementById('pacientesLista');
      const buscaPacientes = document.getElementById('buscaPacientes');
      const statsGrid = document.getElementById('statsGrid');
      const setorForm = document.getElementById('setorForm');
      const setorIdField = setorForm.querySelector('input[name="id"]');
      const setoresLista = document.getElementById('setoresLista');
      const usuarioForm = document.getElementById('usuarioForm');
      const usuariosLista = document.getElementById('usuariosLista');

      const serverCall = (name, ...args) => new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(error => {
            const message = typeof error === 'string' ? error : error?.message || 'Erro inesperado';
            reject(message);
          })[name](...args);
      });

      const showToast = (message, type = 'info') => {
        toast.textContent = message;
        toast.className = `toast ${type} visible`;
        setTimeout(() => toast.classList.remove('visible'), 3800);
      };

      const setLoading = (form, loading) => {
        const button = form.querySelector('button[type="submit"]');
        if (!button) return;
        button.disabled = loading;
        button.dataset.originalText ??= button.textContent;
        button.textContent = loading ? 'Processando…' : button.dataset.originalText;
      };

      const toggleSection = (id) => {
        sections.forEach(sectionId => {
          const element = document.getElementById(`section-${sectionId}`);
          const isActive = sectionId === id;
          element.classList.toggle('active', isActive);
        });

        Array.from(nav.children).forEach(button => {
          button.classList.toggle('active', button.dataset.section === id);
        });
      };

      const buildNavigation = () => {
        nav.innerHTML = '';
        const items = [
          { id: 'dashboard', label: 'Visão geral' },
          { id: 'paciente', label: 'Novo atendimento' },
          { id: 'registros', label: 'Registros' }
        ];

        if (state.user?.nivelAcesso === 0) {
          items.push({ id: 'admin', label: 'Administração' });
        }

        items.forEach(item => {
          const button = document.createElement('button');
          button.type = 'button';
          button.dataset.section = item.id;
          button.textContent = item.label;
          button.className = 'nav-button' + (item.id === 'dashboard' ? ' active' : '');
          button.addEventListener('click', () => toggleSection(item.id));
          nav.appendChild(button);
        });
      };

      const renderStats = () => {
        if (!state.estatisticas) {
          statsGrid.innerHTML = '<div class="empty-state">Nenhum dado disponível ainda.</div>';
          return;
        }

        const { total, atendimentosHoje, porSetor } = state.estatisticas;
        const setores = Object.entries(porSetor || {});

        statsGrid.innerHTML = `
          <div class="stat-card">
            <span>Total de pacientes</span>
            <strong>${total}</strong>
          </div>
          <div class="stat-card">
            <span>Atendimentos de hoje</span>
            <strong>${atendimentosHoje}</strong>
          </div>
        ` + (setores.length ? setores.map(([setor, quantidade]) => `
          <div class="stat-card">
            <span>${setor}</span>
            <strong>${quantidade}</strong>
          </div>
        `).join('') : '');
      };

      const renderPacientes = (filtro = '') => {
        const termo = filtro.trim().toLowerCase();
        const pacientes = !termo ? state.pacientes : state.pacientes.filter(paciente => {
          return [
            paciente.nomePaciente,
            paciente.prontuario,
            paciente.queixaPrincipal,
            paciente.profissional,
            paciente.setor
          ].some(valor => valor?.toLowerCase().includes(termo));
        });

        if (!pacientes.length) {
          pacientesLista.innerHTML = '<div class="empty-state">Nenhum atendimento encontrado.</div>';
          return;
        }

        pacientesLista.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Paciente</th>
                <th>Prontuário</th>
                <th>Profissional</th>
                <th>Setor</th>
                <th>Queixa</th>
              </tr>
            </thead>
            <tbody>
              ${pacientes.map(p => `
                <tr>
                  <td>${p.dataRegistro} às ${p.horaRegistro}</td>
                  <td>${p.nomePaciente}</td>
                  <td>${p.prontuario || '-'}</td>
                  <td>${p.profissional}</td>
                  <td>${p.setor}</td>
                  <td>${p.queixaPrincipal}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      };

      const renderSetores = () => {
        if (!state.setores.length) {
          setoresLista.className = 'empty-state';
          setoresLista.textContent = 'Nenhum setor cadastrado.';
          return;
        }

        setoresLista.className = '';
        setoresLista.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Descrição</th>
                <th>Nível</th>
                <th>Status</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              ${state.setores.map(setor => `
                <tr>
                  <td>${setor.descricao}</td>
                  <td>${['Administrador', 'Profissional', 'Consulta'][Number(setor.nivelAcesso)] || 'N/A'}</td>
                  <td><span class="badge ${setor.ativo ? '' : 'status-inativo'}">${setor.ativo ? 'Ativo' : 'Inativo'}</span></td>
                  <td><button type="button" class="secondary" data-id="${setor.id}">Editar</button></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

        setoresLista.querySelectorAll('button[data-id]').forEach(button => {
          button.addEventListener('click', () => {
            const setor = state.setores.find(item => item.id === Number(button.dataset.id));
            if (!setor) return;
            setorIdField.value = setor.id;
            setorForm.descricao.value = setor.descricao;
            setorForm.nivelAcesso.value = setor.nivelAcesso;
            setorForm.ativo.value = String(setor.ativo);
            toggleSection('admin');
          });
        });

        const select = usuarioForm.querySelector('select[name="setor"]');
        select.innerHTML = state.setores
          .filter(setor => setor.ativo)
          .map(setor => `<option value="${setor.descricao}">${setor.descricao}</option>`)
          .join('');
      };

      const renderUsuarios = () => {
        if (!state.usuarios.length) {
          usuariosLista.className = 'empty-state';
          usuariosLista.textContent = 'Nenhum usuário cadastrado.';
          return;
        }

        usuariosLista.className = '';
        usuariosLista.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Matrícula</th>
                <th>Setor</th>
                <th>Nível</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${state.usuarios.map(usuario => `
                <tr>
                  <td>${usuario.nome}</td>
                  <td>${usuario.matricula}</td>
                  <td>${usuario.setor}</td>
                  <td>${['Administrador', 'Profissional', 'Consulta'][Number(usuario.nivelAcesso)] || 'N/A'}</td>
                  <td><span class="badge ${usuario.status === 'ATIVO' ? '' : 'status-inativo'}">${usuario.status}</span></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      };

      const carregarDados = async () => {
        try {
          const [pacientes, estatisticas, setores, usuarios] = await Promise.all([
            serverCall('listarPacientes'),
            serverCall('obterEstatisticas'),
            serverCall('listarSetores'),
            state.user?.nivelAcesso === 0 ? serverCall('listarUsuarios', state.user.matricula) : Promise.resolve({ success: true, usuarios: [] })
          ]);

          if (pacientes.success) state.pacientes = pacientes.pacientes;
          if (estatisticas.success) state.estatisticas = estatisticas;
          if (setores.success) state.setores = setores.setores;
          if (usuarios.success) state.usuarios = usuarios.usuarios;

          renderStats();
          renderPacientes(buscaPacientes.value);
          renderSetores();
          renderUsuarios();
        } catch (error) {
          showToast(error, 'error');
        }
      };

      loginForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        setLoading(loginForm, true);
        try {
          const credenciais = {
            matricula: loginForm.loginMatricula.value.trim(),
            senha: loginForm.loginSenha.value
          };
          const resposta = await serverCall('fazerLogin', credenciais);
          if (!resposta.success) {
            showToast(resposta.message || 'Não foi possível entrar.', 'error');
            return;
          }

          state.user = resposta.user;
          userChip.textContent = `${state.user.nome} · ${state.user.setor}`;
          loginView.hidden = true;
          app.hidden = false;
          buildNavigation();
          await carregarDados();
          showToast(`Bem-vindo, ${state.user.nome}!`, 'success');
        } catch (error) {
          showToast(error, 'error');
        } finally {
          setLoading(loginForm, false);
          loginForm.reset();
        }
      });

      pacienteForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!state.user) return;
        setLoading(pacienteForm, true);
        try {
          const formData = new FormData(pacienteForm);
          const dados = Object.fromEntries(formData.entries());
          const resposta = await serverCall('registrarPaciente', {
            ...dados,
            profissional: state.user.nome,
            setor: state.user.setor
          });

          if (!resposta.success) {
            showToast(resposta.message || 'Erro ao registrar atendimento.', 'error');
            return;
          }

          pacienteForm.reset();
          await carregarDados();
          showToast('Atendimento registrado com sucesso!', 'success');
        } catch (error) {
          showToast(error, 'error');
        } finally {
          setLoading(pacienteForm, false);
        }
      });

      buscaPacientes.addEventListener('input', (event) => {
        renderPacientes(event.target.value);
      });

      setorForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (state.user?.nivelAcesso !== 0) {
          showToast('Apenas administradores podem alterar setores.', 'error');
          return;
        }

        setLoading(setorForm, true);
        try {
          const formData = new FormData(setorForm);
          const payload = Object.fromEntries(formData.entries());
          payload.id = payload.id ? Number(payload.id) : null;
          payload.nivelAcesso = Number(payload.nivelAcesso);
          payload.ativo = payload.ativo === 'true';

          const resposta = await serverCall('salvarSetor', {
            solicitante: state.user.matricula,
            setor: payload
          });

          if (!resposta.success) {
            showToast(resposta.message || 'Erro ao salvar setor.', 'error');
            return;
          }

          setorForm.reset();
          await carregarDados();
          showToast('Setor salvo com sucesso.', 'success');
        } catch (error) {
          showToast(error, 'error');
        } finally {
          setLoading(setorForm, false);
        }
      });

      usuarioForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (state.user?.nivelAcesso !== 0) {
          showToast('Apenas administradores podem alterar usuários.', 'error');
          return;
        }

        setLoading(usuarioForm, true);
        try {
          const formData = new FormData(usuarioForm);
          const usuario = Object.fromEntries(formData.entries());
          usuario.nivelAcesso = Number(usuario.nivelAcesso);
          const resposta = await serverCall('salvarUsuario', {
            solicitante: state.user.matricula,
            usuario
          });

          if (!resposta.success) {
            showToast(resposta.message || 'Erro ao salvar usuário.', 'error');
            return;
          }

          usuarioForm.reset();
          await carregarDados();
          showToast('Usuário salvo com sucesso.', 'success');
        } catch (error) {
          showToast(error, 'error');
        } finally {
          setLoading(usuarioForm, false);
        }
      });

      setorForm.addEventListener('reset', () => {
        setorIdField.value = '';
      });

      (async () => {
        try {
          await serverCall('configurarSistema');
        } catch (error) {
          console.error(error);
        }
      })();
    })();
  </script>
</body>
</html>
